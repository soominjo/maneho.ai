/**
 * Local development server for tRPC backend
 * Runs on http://localhost:3001
 *
 * Error Handling:
 * - Try-catch around initialization
 * - Unhandled rejection listener
 * - Server error listener
 */

import express from 'express'
import { createHTTPHandler } from '@trpc/server/adapters/standalone'
import { appRouter } from './index'

console.log('[SERVER] 1Ô∏è‚É£  Initializing Express app...')

const app = express()
const port = process.env.PORT || 3001

console.log(`[SERVER] 2Ô∏è‚É£  Port configuration: ${port} (from ${process.env.PORT ? 'ENV' : 'DEFAULT'})`)

// CORS middleware
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*')
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization')
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')

  if (req.method === 'OPTIONS') {
    res.sendStatus(200)
  } else {
    next()
  }
})

// Middleware for JSON parsing
app.use(express.json())

console.log('[SERVER] 3Ô∏è‚É£  Middleware configured (CORS + JSON parser)')

// tRPC endpoint
try {
  console.log('[SERVER] 4Ô∏è‚É£  Setting up tRPC handler...')
  app.use(
    '/trpc',
    createHTTPHandler({
      router: appRouter,
      createContext: () => ({}),
    })
  )
  console.log('[SERVER] 5Ô∏è‚É£  tRPC handler mounted at /trpc')
} catch (error) {
  console.error('[SERVER] ‚ùå FAILED to setup tRPC:', error)
  process.exit(1)
}

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() })
})

// 404 handler
app.use((req, res) => {
  res.status(404).json({ error: 'Not found' })
})

// Start server with error handling
console.log(`[SERVER] 6Ô∏è‚É£  Attempting to listen on port ${port}...`)

let server: ReturnType<typeof app.listen> | null = null

try {
  server = app.listen(port, () => {
    console.log('')
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    console.log('‚úÖ SUCCESS! Server is running')
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    console.log(`üöÄ tRPC server running at http://localhost:${port}`)
    console.log(`üì° API endpoint: http://localhost:${port}/trpc`)
    console.log(`‚ù§Ô∏è  Health check: http://localhost:${port}/health`)
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
    console.log('')
  })

  // Listen for server errors
  server.on('error', (error: NodeJS.ErrnoException) => {
    if (error.code === 'EADDRINUSE') {
      console.error(`[SERVER] ‚ùå ERROR: Port ${port} is already in use`)
      console.error(`[SERVER] Kill the process with: lsof -i :${port} | grep LISTEN | awk '{print $2}' | xargs kill -9`)
    } else if (error.code === 'EACCES') {
      console.error(`[SERVER] ‚ùå ERROR: Permission denied to use port ${port}`)
      console.error(`[SERVER] Try using a port >= 1024 or run with elevated privileges`)
    } else {
      console.error(`[SERVER] ‚ùå Server error (${error.code}):`, error.message)
    }
    process.exit(1)
  })
} catch (error) {
  console.error('[SERVER] ‚ùå FAILED to start server:', error)
  process.exit(1)
}

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\n[SERVER] ‚èπÔ∏è  Shutting down server...')
  if (server) {
    server.close(() => {
      console.log('[SERVER] ‚úÖ Server stopped gracefully')
      process.exit(0)
    })
    // Force exit after 10 seconds
    setTimeout(() => {
      console.error('[SERVER] ‚ùå Server did not shut down in time, forcing exit...')
      process.exit(1)
    }, 10000)
  } else {
    process.exit(0)
  }
})

// Catch unhandled promise rejections
process.on('unhandledRejection', (reason, promise) => {
  console.error('[SERVER] ‚ùå UNHANDLED REJECTION:', reason)
  console.error('[SERVER] Promise:', promise)
})

// Catch uncaught exceptions
process.on('uncaughtException', (error) => {
  console.error('[SERVER] ‚ùå UNCAUGHT EXCEPTION:', error)
  process.exit(1)
})

export default app
